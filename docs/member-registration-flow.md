# Member Registration Flow - Documentation

## Overview

This document describes the complete member registration flow for Koperasi OS, including security measures, validation, and testing.

## Flow Diagram

```
User → Frontend Form → Supabase Auth → API Endpoint → Database (RLS) → Response
```

## Step-by-Step Flow

### 1. User Registration (Supabase Auth)

**Location:** `src/app/register/page.tsx`

1. User fills registration form:
   - Nama Lengkap (required, 3-100 chars)
   - NIK (required, 16 digits)
   - Phone (required, Indonesian format)
   - Email (required, valid email)
   - Password (required, min 8 chars)
   - Alamat Lengkap (required, 10-500 chars)

2. Client-side validation using Zod schema (`src/lib/validations/member.ts`)

3. Submit to Supabase Auth:
   ```typescript
   await supabase.auth.signUp({ email, password })
   ```

### 2. Member Profile Registration (API Endpoint)

**Location:** `src/app/api/members/register/route.ts`

After successful auth registration:

1. **Authentication Check**
   - Verify user session exists
   - Get `auth.uid()` from session

2. **Input Validation**
   - Validate request body with Zod schema
   - Return 400 if validation fails

3. **Duplicate Checks**
   - Check if member already exists for this user_id
   - Check if NIK already exists (unique constraint)

4. **Database Insert**
   ```typescript
   await supabase.from('member').insert({
     koperasi_id: process.env.KOPERASI_ID,
     user_id: auth.uid(), // CRITICAL: Must match auth.uid()
     nama_lengkap: validatedData.nama_lengkap,
     nik: validatedData.nik,
     phone: validatedData.phone,
     email: validatedData.email,
     alamat_lengkap: validatedData.alamat_lengkap,
     member_type: 'regular',
     status: 'pending',
     created_by: auth.uid()
   })
   ```

5. **RLS Policy Enforcement**
   - Policy: `member_insert_own_profile`
   - Constraint: `WITH CHECK (auth.uid() = user_id)`
   - If `user_id` doesn't match `auth.uid()`, RLS will reject the insert

6. **Auto-Generated Fields**
   - `nomor_anggota`: Auto-generated by database trigger
   - `id`: UUID primary key
   - `created_at`: Timestamp
   - `tanggal_daftar`: Current date

### 3. Response

**Success (201):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "nomor_anggota": "ANGGTA-20251216-00001",
    "nama_lengkap": "John Doe",
    "nik": "3201011234567890",
    "status": "pending",
    "created_at": "2025-12-16T10:00:00Z"
  },
  "message": "Member registration successful. Your profile is pending approval."
}
```

**Error (400):**
```json
{
  "error": "Validation failed",
  "details": [
    { "field": "nik", "message": "NIK harus terdiri dari 16 digit" }
  ]
}
```

**Error (409):**
```json
{
  "error": "NIK already registered"
}
```

**Error (403):**
```json
{
  "error": "Permission denied. RLS policy violation.",
  "details": "User ID mismatch detected."
}
```

## Security Measures

### 1. Row Level Security (RLS)

**Policy:** `member_insert_own_profile`

```sql
CREATE POLICY "member_insert_own_profile" ON public.member
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = user_id);
```

**Enforcement:**
- Database-level security boundary
- Cannot be bypassed by application code
- Automatically enforced on every INSERT

### 2. Input Validation

**Client-Side (Zod):**
- Validates before API call
- Provides immediate feedback to user
- Reduces unnecessary API calls

**Server-Side (Zod):**
- Validates all inputs again
- Prevents malicious data injection
- Ensures data integrity

### 3. Authentication

- User must be authenticated before member registration
- Session verified via Supabase Auth
- `auth.uid()` automatically set by Supabase

### 4. Duplicate Prevention

- Unique constraint on `nik` (database level)
- Unique constraint on `user_id` (database level)
- Application-level checks before insert

## Validation Rules

### NIK (Nomor Induk Kependudukan)
- **Format:** 16 digits, numeric only
- **Example:** `3201011234567890`
- **Validation:** `z.string().length(16).regex(/^\d+$/)`

### Phone Number
- **Format:** Indonesian format (08xx or +62xxx)
- **Example:** `081234567890` or `+6281234567890`
- **Validation:** `z.string().regex(/^(\+62|62|0)[0-9]{9,13}$/)`
- **Normalization:** Removes dashes and spaces

### Email
- **Format:** Valid email address
- **Optional:** Can be empty string
- **Validation:** `z.string().email().optional()`

### Nama Lengkap
- **Length:** 3-100 characters
- **Validation:** `z.string().min(3).max(100).trim()`

### Alamat Lengkap
- **Length:** 10-500 characters
- **Validation:** `z.string().min(10).max(500).trim()`

## Error Handling

### Client-Side Errors
- Displayed inline below each field
- Red border on invalid fields
- Submit button disabled during validation errors

### Server-Side Errors
- Returned as JSON response
- Displayed in error message area
- Specific error messages for different scenarios

### Database Errors
- Unique constraint violations → 409 Conflict
- RLS policy violations → 403 Forbidden
- Other database errors → 500 Internal Server Error

## Testing

### Unit Tests
- Zod schema validation tests
- Type inference tests

### Integration Tests
**Location:** `tests/e2e/member-registration.spec.ts`

Tests cover:
- Complete registration flow
- Validation errors (NIK, phone, required fields)
- Duplicate NIK handling
- Loading states
- RLS security verification

### SQL Tests
**Location:** `supabase/migrations/tests/007_member_rls_database_level.sql`

Tests cover:
- RLS policy structure verification
- Policy constraint verification
- Basic role-level RLS checks

## Files Reference

### Frontend
- `src/app/register/page.tsx` - Registration form
- `src/lib/validations/member.ts` - Zod validation schema

### Backend
- `src/app/api/members/register/route.ts` - API endpoint

### Database
- `supabase/migrations/20251216120000_015_fix_member_insert_rls_policy.sql` - RLS policy
- `supabase/migrations/20251214123214_002_add_auto_generate_nomor_anggota.sql` - Auto-generate trigger

### Tests
- `tests/e2e/member-registration.spec.ts` - E2E tests
- `supabase/migrations/tests/007_member_rls_database_level.sql` - SQL tests

## Security Review Checklist

- [x] RLS policy enforces `user_id = auth.uid()`
- [x] Input validation on client and server
- [x] Authentication required before member registration
- [x] Duplicate checks (NIK, user_id)
- [x] Error handling for all scenarios
- [x] No direct database access from client
- [x] All writes go through API endpoint
- [x] Audit trail (`created_by` field)
- [x] Integration tests verify RLS
- [x] SQL tests verify policy structure

## Known Limitations

1. **Koperasi ID:** Currently uses environment variable or hardcoded value. Should be retrieved from database or user context in production.

2. **Email Verification:** Supabase Auth handles email verification separately. Member status remains "pending" until admin approval.

3. **RLS Testing:** Full `auth.uid()` testing requires Supabase Auth context. SQL tests verify structure but not full behavior.

## Future Improvements

1. **Multi-step Registration:** Separate auth registration from member profile completion
2. **Document Upload:** Add document upload capability during registration
3. **Admin Approval:** Implement admin approval workflow
4. **Email Notifications:** Send confirmation emails after registration
5. **Koperasi Selection:** Allow users to select/join specific koperasi

## Related Documentation

- [Security Issue Documentation](./security/member-rls-security-issue.md)
- [Architecture Documentation](../arsitektur-final.md)
- [RLS Policy Documentation](../arsitektur-final.md#-keamanan)


