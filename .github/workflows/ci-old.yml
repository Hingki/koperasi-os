name: CI

on:
  push:
    branches: [ main, feature/** ]
  pull_request:
    branches: [ main ]

jobs:
  lint-build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Lint migrations
        run: npm run lint:migrations
      - name: Build
        run: npm run build
      - name: Test
        run: npm test

  migrations-preview:
    needs: lint-build-test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 5s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Install psql client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 && break || sleep 1
          done
      - name: Prepare minimal auth schema
        run: |
          export PGPASSWORD=postgres
          psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 <<'SQL'
          CREATE SCHEMA IF NOT EXISTS auth;
          CREATE TABLE IF NOT EXISTS auth.users (id UUID PRIMARY KEY);
          SQL
      - name: Ensure minimal roles exist
        run: |
          export PGPASSWORD=postgres
          psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 <<'SQL'
          DO $$
          BEGIN
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'anon') THEN
              CREATE ROLE anon;
            END IF;
            IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'authenticated') THEN
              CREATE ROLE authenticated;
            END IF;
          END$$;
          SQL
      - name: Run migrations (skip archived)
        run: |
          set -euo pipefail
          export PGPASSWORD=postgres
          files=(supabase/migrations/*.sql)
          for f in "${files[@]}"; do
            if grep -q -i 'ARCHIVED and disabled' "$f"; then
              echo "Skipping archived: $f"
              continue
            fi
            echo "Applying: $f"
            psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 -f "$f"
          done
      - name: Run migration smoke tests
        run: |
          set -euo pipefail
          export PGPASSWORD=postgres
          if [ -f supabase/migrations/tests/001_rbac_smoke.sql ]; then
            echo "Running RBAC smoke test"
            psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 -f supabase/migrations/tests/001_rbac_smoke.sql
          else
            echo "No migration tests found"
          fi
      - name: Run role permission tests
        run: |
          set -euo pipefail
          export PGPASSWORD=postgres
          if [ -f supabase/migrations/tests/002_roles_permissions.sql ]; then
            echo "Running role permission tests"
            psql -h localhost -U postgres -d postgres -v ON_ERROR_STOP=1 -f supabase/migrations/tests/002_roles_permissions.sql
          else
            echo "No role tests found"
          fi

  preview-deploy:
    if: github.event_name == 'pull_request' && secrets.VERCEL_TOKEN
    needs: lint-build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy preview to Vercel
        id: vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: ''
          working-directory: .
      - name: Export PREVIEW_URL
        run: echo "PREVIEW_URL=${{ steps.vercel.outputs.preview_url }}" >> $GITHUB_ENV
      - name: Comment PR with preview URL
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Preview deployment: ${{ steps.vercel.outputs.preview_url }}

  e2e:
    needs: [lint-build-test, migrations-preview, preview-deploy]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Start app (unless PREVIEW_URL provided)
        run: |
          if [ -z "${PREVIEW_URL-}" ]; then
            npm run start &
            n=0; until curl -sSf http://localhost:3000 >/dev/null || [ "$n" -ge 30 ]; do n=$((n+1)); sleep 1; done
          else
            echo "Using PREVIEW_URL=$PREVIEW_URL for E2E tests"
          fi
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      - name: Run E2E tests
        run: |
          set -euo pipefail
          if [ -n "${PREVIEW_URL-}" ]; then
            export PLAYWRIGHT_BASE_URL="$PREVIEW_URL"
            echo "PLAYWRIGHT_BASE_URL=$PLAYWRIGHT_BASE_URL"
          fi
          npm run e2e
      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

  publish-playwright-report:
    needs: e2e
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download Playwright report artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: ./playwright-report
      - name: Deploy Playwright report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright-report
          publish_branch: gh-pages
      - name: Comment PR with report URL
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Playwright report published: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

  deploy:
    needs: [lint-build-test, migrations-preview, e2e]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && secrets.VERCEL_TOKEN
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: --prod
          working-directory: .